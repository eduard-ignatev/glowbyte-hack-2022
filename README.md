# GLOWBYTE HACK 2022
Проект был создан в рамках хакатона [GLOWBYTE HACK 2022](https://datapeople.ru/glowbytehack2022). Работа включает в себя:
- Создание целевой структуры хранилища данных
- Разработка ETL процесса
- Настройка ежедневного запуска таска
- Создание витрин данных для бизнес пользователей

Решение построено на `Python` и `SQL`. Планировщик - `Jobber`. База данных - `PostgreSQL` (инфраструктура организатора).

#### Сильные стороны решения:
- Реализована инкрементальная загрузка для снижения нагрузки на источник
- Реализована версионность по типу SCD2 в таблицах измерений
- Безопасность данных - использование SSL/TLS при подключении к FTP и базам данных
- Логгирование этапов по ходу выполнения скрипта
- Планировщик приостанавливает таск при возникновении ошибки

## Техническое задание на разработку хранилища данных
Задача первого этапа - настроить ETL процесс, который будет забирать данные из источника и раскладывать их по целевым таблицам в описанную в документации структуру в хранилище.

### 1й источник данных - СУБД PostgreSQL
image.png

**Таблица main.rides**  
Заказы, поступающие от клиентов.

**Таблица main.movement**  
Статусы машин, направленных на заказ. Каждый статус добавляется новой строкой с временно́й меткой. При успешно выполненном заказе по одному заказу будет три записи - подача машины (READY), начало поездки (BEGIN) и окончание поездки (END). Отмена заказа (CANCEL) возможна только до его начала, при этом завершения заказа (END) не будет.

**Таблица main.car_pool**  
Машины, зарегистрированные в автопарке. Машина регистрируется при первом участии ее в любой поездке. Каждые три дня машина должна проходить осмотр, отметка о проведении осмотра обновляется в таблице.

**Таблица main.drivers**  
Водители, работающие в компании. Водители могут добавляться независимо от поездок. Иногда у водителя может меняться номер карты, это изменение фиксируется обновлением соответствующего поля.

### 2й источник данных - файловые выгрузки FTP
**Каталог waybills**  
Содержит путевые листы в формате XML, в одном файле один путевой лист. Путевые листы содержат информацию о том, какой водитель в какой период времени на какой машине работал.

image.png

**Каталог payments**  
Содержит бухгалтерские выписки о поступлении денег от клиентов на
счет компании в формате CSV.

### Требования к хранилищу данных
В детальном слое хранилища создаются таблицы, описывающие каждую бизнес-сущность, существующую в компании.

Фактовые таблицы:
- fact_rides
- fact_payments
- fact_waybills

Таблицы-измерения:
- dim_clients
- dim_cars
- dim_drivers

Заполнение фактовой таблицы fact_rides должно производиться только для
завершенных поездок. То есть в источнике для поездки должен стоять либо статус END, либо статус CANCEL. Незавершенные поездки недопустимы.

image.png

### Требования к отчетам
Для ежедневных витрин необходимо построить полный отчет за завершенный
день. При этом в одной таблице хранятся отчеты за все дни, у каждого из них свое значения даты, на которую построен отчет - report_dt (обратите внимание, это не то же самое что дата построения отчета).

Для историчных витрин записи (версии) добавляются по мере поступления
данных, хранятся записи о всех элементах сущности в формате SCD2.

#### 1. Выплата водителям (rep_drivers_payments)
Ежедневная витрина.

Критерии построения:
- услуги сервиса - 20% от стоимости поездки,
- стоимость топливо - 47,26 * 7 * дистанция / 100,
- амортизация машины 5 руб / км * дистанция,
- остаток достается водителю.

Атрибуты таблицы:
- personnel_num - табельный номер водителя,
- last_name - фаамилия,
- first_name - имя,
- middle_name - отчество,
- card_num - номер карты водителя,
- amount - сумма к выплате,
- report_dt - дата, на которую построен отчет.

#### 2. Водители-нарушители (rep_drivers_violations)
Ежедневная витрина.

Критерии:
- завершил поездку со средней скоростью более 85 км/ч.

Атрибуты:
- personnel_num - табельный номер водителя,
- ride - идентификатор поездки,
- speed - средняя скорость,
- violations_cnt - количество таких нарушений, выявленных ранее,
накопленной суммой. Первое нарушение - значение 0.

#### 3. Перерабатывающие водители (rep_drivers_overtime)
Ежедневная витрина.

Критерии:
- водитель работал больше 7 часов за 24 часа (по путевым листам).
- нарушением считается тот путевой лист, который вышел за пределы 8
часов. Таких путевых листов может быть много.
- дата нарушения - по дате начала работы в путевом листе.

Атрибуты:
- personnel_num - табельный номер водителя,
- дата-время старта 24-часового периода, где он работал больше 8 часов
- суммарная наработка

#### 4. “Знай своего клиента” (rep_clients_hist)
Историчная витрина.

Атрибуты:
- client_id - идентификатор клиента (суррогатный ключ),
- phone_num - номер телефона клиента,
- rides_cnt - количество поездок,
- cancelled_cnt - сколько поездок отменено,
- spent_amt - сколько денег потрачено,
- debt_amt - задолженность,
- start_dt - начало версии,
- end_dt - конец версии,
- deleted_flag - признак логического удаления.

## Демонстрация
Выполнение скрипта:


Настроенный планировщик:


Результирующие таблицы:

