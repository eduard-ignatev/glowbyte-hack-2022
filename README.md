# GlowByte Hack 2022 - 2nd Place Winner
Проект был создан в рамках хакатона [GlowByte Hack 2022](https://datapeople.ru/glowbytehack2022). Работа включает в себя:
- Создание целевой структуры хранилища данных
- Разработка ETL процесса
- Настройка ежедневного запуска таска
- Создание витрин данных для бизнес пользователей

Решение построено на `Python` и `SQL`. Планировщик - `Jobber`. База данных - `PostgreSQL` (инфраструктура организатора).

Фичи:
- Реализована инкрементальная загрузка для снижения нагрузки на источник
- Реализована версионность по типу SCD2 в таблицах измерений
- Безопасность данных - использование SSL/TLS при подключении к FTP и базам данных
- Логгирование этапов по ходу выполнения скрипта
- Планировщик приостанавливает таск при возникновении ошибки

## Техническое задание на разработку хранилища данных
Задача первого этапа - настроить ETL процесс, который будет забирать данные из источника и раскладывать их по целевым таблицам в описанную в документации структуру в хранилище.

### 1й источник данных - СУБД PostgreSQL
![Source DB ER](https://user-images.githubusercontent.com/97912967/201328673-f61d6640-bd89-4b06-b59d-a733b61d80ed.png)

**Таблица main.rides**  
Заказы, поступающие от клиентов.

**Таблица main.movement**  
Статусы машин, направленных на заказ. Каждый статус добавляется новой строкой с временно́й меткой. При успешно выполненном заказе по одному заказу будет три записи - подача машины (READY), начало поездки (BEGIN) и окончание поездки (END). Отмена заказа (CANCEL) возможна только до его начала, при этом завершения заказа (END) не будет.

**Таблица main.car_pool**  
Машины, зарегистрированные в автопарке. Машина регистрируется при первом участии ее в любой поездке. Каждые три дня машина должна проходить осмотр, отметка о проведении осмотра обновляется в таблице.

**Таблица main.drivers**  
Водители, работающие в компании. Водители могут добавляться независимо от поездок. Иногда у водителя может меняться номер карты, это изменение фиксируется обновлением соответствующего поля.

### 2й источник данных - файловые выгрузки FTP
**Каталог waybills**  
Содержит путевые листы в формате XML, в одном файле один путевой лист. Путевые листы содержат информацию о том, какой водитель в какой период времени на какой машине работал.

![Waybill structure](https://user-images.githubusercontent.com/97912967/201328741-4ee66306-2952-48e9-b2b7-aa11066797de.png)

**Каталог payments**  
Содержит бухгалтерские выписки о поступлении денег от клиентов на
счет компании в формате CSV.

### Требования к хранилищу данных
В детальном слое хранилища создаются таблицы, описывающие каждую бизнес-сущность, существующую в компании.

Фактовые таблицы:
- fact_rides
- fact_payments
- fact_waybills

Таблицы-измерения:
- dim_clients
- dim_cars
- dim_drivers

Заполнение фактовой таблицы fact_rides должно производиться только для
завершенных поездок. То есть в источнике для поездки должен стоять либо статус END, либо статус CANCEL. Незавершенные поездки недопустимы.

![Target DWH ER](https://user-images.githubusercontent.com/97912967/201328780-326f2640-c104-4b16-a024-4283284d10da.png)

### Требования к отчетам
Для ежедневных витрин необходимо построить полный отчет за завершенный
день. При этом в одной таблице хранятся отчеты за все дни, у каждого из них свое значения даты, на которую построен отчет - report_dt (обратите внимание, это не то же самое что дата построения отчета).

Для историчных витрин записи (версии) добавляются по мере поступления
данных, хранятся записи о всех элементах сущности в формате SCD2.

#### 1. Выплата водителям (rep_drivers_payments)
Ежедневная витрина.

Критерии построения:
- услуги сервиса - 20% от стоимости поездки,
- стоимость топливо - 47,26 * 7 * дистанция / 100,
- амортизация машины 5 руб / км * дистанция,
- остаток достается водителю.

Атрибуты таблицы:
- personnel_num - табельный номер водителя,
- last_name - фаамилия,
- first_name - имя,
- middle_name - отчество,
- card_num - номер карты водителя,
- amount - сумма к выплате,
- report_dt - дата, на которую построен отчет.

#### 2. Водители-нарушители (rep_drivers_violations)
Ежедневная витрина.

Критерии:
- завершил поездку со средней скоростью более 85 км/ч.

Атрибуты:
- personnel_num - табельный номер водителя,
- ride - идентификатор поездки,
- speed - средняя скорость,
- violations_cnt - количество таких нарушений, выявленных ранее,
накопленной суммой. Первое нарушение - значение 0.

#### 3. Перерабатывающие водители (rep_drivers_overtime)
Ежедневная витрина.

Критерии:
- водитель работал больше 7 часов за 24 часа (по путевым листам).
- нарушением считается тот путевой лист, который вышел за пределы 8
часов. Таких путевых листов может быть много.
- дата нарушения - по дате начала работы в путевом листе.

Атрибуты:
- personnel_num - табельный номер водителя,
- дата-время старта 24-часового периода, где он работал больше 8 часов
- суммарная наработка

#### 4. “Знай своего клиента” (rep_clients_hist)
Историчная витрина.

Атрибуты:
- client_id - идентификатор клиента (суррогатный ключ),
- phone_num - номер телефона клиента,
- rides_cnt - количество поездок,
- cancelled_cnt - сколько поездок отменено,
- spent_amt - сколько денег потрачено,
- debt_amt - задолженность,
- start_dt - начало версии,
- end_dt - конец версии,
- deleted_flag - признак логического удаления.

## Демонстрация
Выполнение скрипта:
![Script running](https://user-images.githubusercontent.com/97912967/201327690-849a576b-c2a8-46b5-893f-8f63954f8661.png)

Настроенный планировщик:
![Scheduler](https://user-images.githubusercontent.com/97912967/201327716-361f6253-a7ac-4b9e-a2d5-d09fd04c1fd0.png)

Результирующие таблицы:
![fact_waybills](https://user-images.githubusercontent.com/97912967/201328119-37b33a2f-0a6e-45bf-ad69-40131bff6cfc.png)
![fact_payments](https://user-images.githubusercontent.com/97912967/201328124-a1a92c78-8ab8-410a-85a3-7ddf1dc7850c.png)
![fact_rides](https://user-images.githubusercontent.com/97912967/201328126-5f72d320-dc3d-4d99-a0bd-1b2754538a74.png)
![dim_cars](https://user-images.githubusercontent.com/97912967/201328127-1db803b2-e4b3-4e9b-b481-d4d3eb845a94.png)
![dim_drivers](https://user-images.githubusercontent.com/97912967/201328128-e3ce7c5d-0107-438f-8db1-3a8370c5c608.png)
![dim_clients](https://user-images.githubusercontent.com/97912967/201328132-4e61ebd5-c5c0-4652-b16b-03e426dd1bbd.png)
![rep_drivers_payments](https://user-images.githubusercontent.com/97912967/201328134-187d2d81-bbde-4158-a94f-b305ab0967cb.png)
![rep_drivers_violations](https://user-images.githubusercontent.com/97912967/201328140-aaaf4d81-8fce-4221-ab10-e2c5f72f38a6.png)
![rep_drivers_overtime](https://user-images.githubusercontent.com/97912967/201328141-d802e0fd-9be0-4f8d-8e0e-6d6ef9826c6f.png)
![rep_clients_hist](https://user-images.githubusercontent.com/97912967/201328533-32211bf2-b8a4-42f0-8e59-0c262e016188.png)
![work_batchdate](https://user-images.githubusercontent.com/97912967/201328559-db5f3ba1-f67d-4eaa-8c25-4a11d437bc2a.png)
